--@name Table Clone Deep
--@author legokidlogan
--@shared

if table.cloneDeep then return end

local _tableCloneDeep
local isClassObject = isClassObject


--[[
    - Similar to table.copy(), but performs deep clones of Vectors, Angles, and Colors as well.
    - Also respects middleclass objects, preserving their reference instead of deep-cloning them.
        - If you want a specific class to be deep-cloned, then define a :cloneDeep() method on it.

    source: (any)
        - The table or value to clone.
    layerLimit: (optional) (number)
        - The maximum number of subtable layers to clone.
        - Anything beyond this will still end up in the result, but will not be deep clones.
        - Defaults to 8.

    RETURNS: out
        out: (any)
            - The cloned table or value.
--]]
function table.cloneDeep( source, layerLimit )
    return _tableCloneDeep( source, layerLimit or 8, {}, 1 )
end


_tableCloneDeep = function( source, layerLimit, target, layer )
    if layer > layerLimit then return target end

    local sourceType = type( source )

    if sourceType == "Vector" then
        return Vector( source.x, source.y, source.z )
    elseif sourceType == "Angle" then
        return Angle( source.p, source.y, source.r )
    elseif sourceType == "Color" then
        return Color( source.r, source.g, source.b, source.a )
    elseif sourceType ~= "table" then
        return source
    elseif isClassObject( source ) then
        if source.cloneDeep then return source:cloneDeep() end

        return source
    end

    for key, val in pairs( source ) do
        if type( val ) == "table" then
            local targetVal = {}

            target[key] = targetVal
            _tableCloneDeep( val, targetVal, layer + 1 )
        else
            target[key] = _tableCloneDeep( val, target, layer + 1 )
        end
    end

    return target
end

-- Redefine if lkl/middleclass_extras.txt isn't present.
if not isClassObject then
    isClassObject = function( classObj )
        --if type( classObj ) ~= "table" then return false end
        if classObj.name == nil then return false end
        if classObj.subclass == nil then return false end
        if classObj.allocate == nil then return false end

        return true
    end
end
